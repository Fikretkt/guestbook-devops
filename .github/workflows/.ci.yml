# 1. Pipeline'ın adı (GitHub arayüzünde böyle görünecek)
name: Guestbook CI Pipeline

# 2. Bu robot ne zaman çalışsın?
on:
  push:
    branches: [ "main" ] # Sadece main koluna kod gönderilince çalış
  pull_request:
    branches: [ "main" ] # Birisi kodunu değiştirmek isteyip istek açınca çalış

# 3. Robotun yapacağı işler (Jobs)
jobs:
  build-and-test:
    # GitHub'ın bize bedava verdiği Ubuntu işletim sistemli sanal makine
    runs-on: ubuntu-latest

    steps:
    # A - GitHub'daki kodlarımızı bu sanal makinenin içine kopyalar
    - name: Checkout Code
      uses: actions/checkout@v4

    # B - Docker Compose'un çalışıp çalışmadığını test eder.
    # Eğer Dockerfile'da bir hata varsa, bu adım 'Fail' olur ve kırmızı yanar.
    - name: Build the Stack
      run: docker compose build

    # C - Sistemin ayağa kalkıp kalkmadığını kontrol eder.
    - name: Run Containers
      run: docker compose up -d

    # D - Uygulama cevap veriyor mu? (Health Check)
    - name: Check PHP Application Status
      run: |
        echo "--- 30 Saniye Bekleniyor (MySQL Hazırlığı İçin) ---"
        sleep 30

        echo "--- DATABASE LOGS (MySQL ne durumda?) ---"
        docker compose logs db

        echo "--- API RESPONSE (Gerçek Hata Mesajı) ---"
        # -f parametresini kaldırdık, böylece 500 hatası gelse de JSON içeriğini göreceğiz.
        # -s: Sessiz mod, -S: Hata varsa göster.
        curl -sS http://localhost:8081 | jq '.' || echo "CURL Hatası: Veri JSON değil veya servis kapalı"

        echo "--- SON KONTROL ---"
        # Pipeline'ın başarılı bitmesi için 200 OK gelip gelmediğini kontrol ediyoruz.
        if curl -s --head  --request GET http://localhost:8081 | grep "200 OK" > /dev/null; then 
           echo "Sistem Başarıyla Çalışıyor!"
           exit 0
        else
           echo "Sistem hala 500 hatası veriyor, yukarıdaki logları incele."
           exit 1
        fi

    - name: Debug Network and Containers
      run: |
        docker ps # Hangi konteynerler çalışıyor?
        docker network ls # Ağlar oluşturulmuş mu?
        sleep 30
        curl -s http://localhost:8081 | jq '.'

      # E - Docker Hub'a Giriş Yap (Güvenli şekilde Secrets kullanarak)
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # F - İmajı Build Et ve Pushla
    - name: Build and Push Image
      uses: docker/build-push-action@v5
      with:
        context: ./app # Dockerfile'ın olduğu klasör
        push: true     # İmajı depoya gönder
        # Buraya kendi kullanıcı adını yazmalısın (Örn: fikret/guestbook-app)
        tags: ${{ secrets.DOCKER_USERNAME }}/guestbook-app:latest